{% extends "base.html" %}

{% block title %}Manage Problems - Mentor Hub{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-graduation-cap"></i>
                <span>Mentor Hub</span>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                {% if session['role'] == 'admin' %}
                <a href="{{ url_for('admin_dashboard') }}" class="nav-link">
                    <i class="fas fa-home"></i> <span>Dashboard</span>
                </a>
                <a href="{{ url_for('admin_users') }}" class="nav-link">
                    <i class="fas fa-users-cog"></i> <span>Users</span>
                </a>
                <a href="{{ url_for('admin_mentors') }}" class="nav-link">
                    <i class="fas fa-chalkboard-teacher"></i> <span>Mentors</span>
                </a>
                <a href="{{ url_for('admin_students') }}" class="nav-link">
                    <i class="fas fa-user-graduate"></i> <span>Students</span>
                </a>
                <div class="nav-section-title" style="margin-top: 1rem;">Content</div>
                <a href="{{ url_for('admin_tasks') }}" class="nav-link">
                    <i class="fas fa-tasks"></i> <span>Tasks</span>
                </a>
                <a href="{{ url_for('admin_problems') }}" class="nav-link active">
                    <i class="fas fa-code"></i> <span>Assignments</span>
                </a>
                <a href="{{ url_for('admin_aptitude') }}" class="nav-link">
                    <i class="fas fa-clipboard-check"></i> <span>Aptitude Test</span>
                </a>
                {% else %}
                <a href="{{ url_for('mentor_dashboard') }}" class="nav-link">
                    <i class="fas fa-home"></i> <span>Dashboard</span>
                </a>
                <a href="{{ url_for('mentor_tasks') }}" class="nav-link">
                    <i class="fas fa-tasks"></i> <span>Tasks</span>
                </a>
                <a href="{{ url_for('mentor_problems') }}" class="nav-link active">
                    <i class="fas fa-code"></i> <span>Problems</span>
                </a>
                <a href="{{ url_for('mentor_aptitude') }}" class="nav-link">
                    <i class="fas fa-clipboard-check"></i> <span>Aptitude Test</span>
                </a>
                <a href="{{ url_for('mentor_leaderboard') }}" class="nav-link">
                    <i class="fas fa-trophy"></i> <span>Leaderboard</span>
                </a>
                {% endif %}
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" style="background: var(--gradient-info);">{{ session['user_name'][0] }}</div>
                <div class="user-details">
                    <div class="user-name">{{ session['user_name'] }}</div>
                    <div class="user-role">{{ session['role'].capitalize() }}</div>
                </div>
            </div>
            <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-block btn-sm">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Manage Problems</h1>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <div class="content-body">
            <!-- Create Problem Form -->
            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h2><i class="fas fa-plus-circle"></i> Create New Problem</h2>
                </div>
                <div class="card-body">
                    <form id="createProblemForm">
                        <div class="form-row">
                            <div class="form-field">
                                <label>Problem Title</label>
                                <input type="text" id="problemTitle" placeholder="Enter problem title" required>
                            </div>
                            <div class="form-field">
                                <label>Problem Type</label>
                                <select id="problemType" onchange="updateLanguageOptions()">
                                    <option value="coding">Coding</option>
                                    <option value="sql">SQL</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Language</label>
                                <select id="problemLanguage">
                                    <option value="python">Python</option>
                                    <option value="c">C</option>
                                    <option value="cpp">C++</option>
                                    <option value="java">Java</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label>Difficulty</label>
                                <select id="problemDifficulty">
                                    <option value="easy">Easy</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-field">
                            <label>Problem Description</label>
                            <textarea id="problemDescription" placeholder="Enter detailed problem description..."
                                required></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Test Cases (Example Input)</label>
                                <input type="text" id="problemTestCases" placeholder="e.g., [1, 2, 3], target=5">
                            </div>
                            <div class="form-field">
                                <label>Expected Output</label>
                                <input type="text" id="problemExpectedOutput" placeholder="e.g., [0, 2]">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field" style="grid-column: span 2;">
                                <label>Exam Constraints</label>
                                <div
                                    style="display: flex; gap: 1.5rem; background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="constraintBlockPaste">
                                        <span>Block Copy/Paste</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="constraintDisableHints">
                                        <span>Disable Hints</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="constraintTrackFocus">
                                        <span>Track Focus Lost</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="resetProblemForm()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <button type="submit" class="btn btn-primary" id="createProblemBtn">
                                <i class="fas fa-plus"></i> Create Problem
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Problems List -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-list"></i> My Problems</h2>
                    <div class="tabs" style="max-width: 300px; margin: 0;">
                        <button class="tab-btn active" onclick="filterProblems('all')">All</button>
                        <button class="tab-btn" onclick="filterProblems('coding')">Coding</button>
                        <button class="tab-btn" onclick="filterProblems('sql')">SQL</button>
                    </div>
                </div>
                <div class="card-body table-container" id="problemsTable">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    let allProblems = [];

    document.addEventListener('DOMContentLoaded', function () {
        loadProblems();

        document.getElementById('createProblemForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            await createProblem();
        });
    });


    function updateLanguageOptions() {
        const type = document.getElementById('problemType').value;
        const langSelect = document.getElementById('problemLanguage');
        const expectedOutputField = document.getElementById('problemExpectedOutput').closest('.form-field');

        if (type === 'sql') {
            langSelect.innerHTML = '<option value="sql">SQL</option>';
            langSelect.disabled = true;
            if (expectedOutputField) expectedOutputField.style.display = 'none';
        } else {
            langSelect.innerHTML = `
            <option value="python">Python</option>
            <option value="c">C</option>
            <option value="cpp">C++</option>
            <option value="java">Java</option>
        `;
            langSelect.disabled = false;
            if (expectedOutputField) expectedOutputField.style.display = 'block';
        }
    }

    async function loadProblems() {
        const container = document.getElementById('problemsTable');

        try {
            const response = await fetch('/api/problems');
            allProblems = await response.json();

            renderProblems(allProblems);
        } catch (error) {
            container.innerHTML = '<p class="error">Failed to load problems</p>';
        }
    }

    function filterProblems(type) {
        document.querySelectorAll('.card-header .tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        if (type === 'all') {
            renderProblems(allProblems);
        } else {
            renderProblems(allProblems.filter(p => p.problem_type === type));
        }
    }

    function renderProblems(problems) {
        const container = document.getElementById('problemsTable');

        if (problems.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon"><i class="fas fa-code"></i></div>
                <h3>No problems created yet</h3>
                <p>Create your first problem using the form above.</p>
            </div>
        `;
            return;
        }

        container.innerHTML = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Difficulty</th>
                    <th>Submissions</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${problems.map(problem => {
            const allCompleted = problem.submissions_count >= problem.total_students && problem.total_students > 0;
            return `
                        <tr>
                            <td>
                                <strong>${problem.title}</strong>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    ${problem.language ? problem.language.toUpperCase() : 'SQL'}
                                </div>
                            </td>
                            <td>
                                <span class="type-badge ${problem.problem_type}">
                                    <i class="fas fa-${problem.problem_type === 'coding' ? 'code' : 'database'}"></i>
                                    ${problem.problem_type}
                                </span>
                            </td>
                            <td>
                                <span class="difficulty-badge ${problem.difficulty}">${problem.difficulty}</span>
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; min-width: 60px;">
                                        <div style="width: ${problem.total_students > 0 ? (problem.submissions_count / problem.total_students * 100) : 0}%; height: 100%; background: var(--gradient-success);"></div>
                                    </div>
                                    <span style="font-size: 0.875rem;">${problem.submissions_count || 0}/${problem.total_students || 0}</span>
                                </div>
                            </td>
                            <td>
                                <span class="status-badge ${problem.is_active ? 'active' : 'inactive'}">
                                    ${problem.is_active ? 'Live' : 'Inactive'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteProblem(${problem.id})" ${allCompleted ? '' : 'disabled'} title="${allCompleted ? 'Delete problem' : 'All students must solve first'}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
        }).join('')}
            </tbody>
        </table>
    `;
    }

    async function createProblem() {
        const btn = document.getElementById('createProblemBtn');

        const constraints = {
            block_paste: document.getElementById('constraintBlockPaste').checked,
            disable_hints: document.getElementById('constraintDisableHints').checked,
            track_focus: document.getElementById('constraintTrackFocus').checked
        };

        const data = {
            title: document.getElementById('problemTitle').value,
            problem_type: document.getElementById('problemType').value,
            language: document.getElementById('problemLanguage').value,
            difficulty: document.getElementById('problemDifficulty').value,
            description: document.getElementById('problemDescription').value,
            test_cases: document.getElementById('problemTestCases').value,
            expected_output: document.getElementById('problemExpectedOutput').value,
            constraints: constraints
        };

        if (!data.title.trim() || !data.description.trim()) {
            showToast('error', 'Error', 'Please fill in all required fields');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

        try {
            const response = await fetch('/api/problems', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showToast('success', 'Success', 'Problem created successfully');
                resetProblemForm();
                loadProblems();
            } else {
                showToast('error', 'Error', result.message || 'Failed to create problem');
            }
        } catch (error) {
            showToast('error', 'Error', 'Failed to create problem');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plus"></i> Create Problem';
        }
    }

    function resetProblemForm() {
        document.getElementById('problemTitle').value = '';
        document.getElementById('problemType').value = 'coding';
        document.getElementById('problemDifficulty').value = 'medium';
        document.getElementById('problemDescription').value = '';
        document.getElementById('problemTestCases').value = '';
        document.getElementById('problemExpectedOutput').value = '';
        updateLanguageOptions();
    }

    async function deleteProblem(problemId) {
        if (!await confirm('Are you sure you want to delete this problem? All submissions will also be deleted.')) {
            return;
        }

        try {
            const response = await fetch(`/api/problems/${problemId}`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                showToast('success', 'Success', 'Problem deleted successfully');
                loadProblems();
            } else {
                showToast('error', 'Error', result.message || 'Failed to delete problem');
            }
        } catch (error) {
            showToast('error', 'Error', 'Failed to delete problem');
        }
    }
</script>
{% endblock %}
