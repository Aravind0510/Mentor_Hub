{% extends "base.html" %}

{% block title %}My Submissions - Mentor Hub{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-graduation-cap"></i>
                <span>Mentor Hub</span>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="{{ url_for('student_dashboard') }}" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('student_tasks') }}" class="nav-link">
                    <i class="fas fa-tasks"></i>
                    <span>Tasks</span>
                </a>
                <a href="{{ url_for('student_assignments') }}" class="nav-link">
                    <i class="fas fa-code"></i>
                    <span>Assignments</span>
                </a>
                <a href="{{ url_for('student_aptitude') }}" class="nav-link">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Aptitude Test</span>
                </a>
                <a href="{{ url_for('student_submissions') }}" class="nav-link active">
                    <i class="fas fa-paper-plane"></i>
                    <span>My Submissions</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">{{ session['user_name'][0] }}</div>
                <div class="user-details">
                    <div class="user-name">{{ session['user_name'] }}</div>
                    <div class="user-role">Student</div>
                </div>
            </div>
            <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-block btn-sm">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>My Submissions</h1>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <div class="content-body">
            <!-- Tabs -->
            <div class="tabs" style="max-width: 400px; margin-bottom: 1.5rem;">
                <button class="tab-btn active" data-tab="tasks">Task Submissions</button>
                <button class="tab-btn" data-tab="problems">Problem Submissions</button>
                <button class="tab-btn" data-tab="aptitude">Aptitude Submissions</button>
            </div>

            <div class="tab-contents">
                <div class="tab-content active" data-tab-content="tasks">
                    <div class="card">
                        <div class="card-body table-container" id="taskSubmissionsTable">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" data-tab-content="problems">
                    <div class="card">
                        <div class="card-body table-container" id="problemSubmissionsTable">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" data-tab-content="aptitude">
                    <div class="card">
                        <div class="card-body table-container" id="aptitudeSubmissionsTable">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Report Modal -->
<div class="modal-overlay" id="reportModal">
    <div class="modal" style="max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="flex-shrink: 0;">
            <h2>Submission Report</h2>
            <button class="modal-close" onclick="closeModal('reportModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="reportContent" style="flex: 1; overflow-y: auto; max-height: 65vh;">
        </div>
        <div class="modal-footer"
            style="flex-shrink: 0; border-top: 1px solid var(--bg-tertiary); padding: 1rem; background: var(--bg-card);">
            <button class="btn btn-secondary" onclick="closeModal('reportModal')">Close</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadTaskSubmissions();
        loadProblemSubmissions();
        initTabs();
    });

    function getStatusDisplay(status, score) {
        // Show REJECTED instead of PENDING for 0 scores
        if (status === 'pending' || (score === 0 && status !== 'accepted')) {
            return 'rejected';
        }
        return status;
    }

    function parseEvaluation(submission) {
        // Try to parse the structured evaluation from ai_explanation
        let evalData = {};
        if (submission.ai_explanation) {
            try {
                evalData = JSON.parse(submission.ai_explanation);
                // Check if it has structured data
                if (evalData.correctness || evalData.efficiency) {
                    return evalData;
                }
            } catch (e) {
                // If it's not JSON, generate fallback based on score
            }
        }

        // Generate fallback values based on score for old submissions
        const score = submission.score || 0;
        if (score > 0) {
            return {
                correctness: `Evaluation completed - ${Math.round(score * 0.4)}/40`,
                efficiency: `Approach assessed - ${Math.round(score * 0.25)}/25`,
                code_style: `Style reviewed - ${Math.round(score * 0.2)}/20`,
                best_practices: `Practices checked - ${Math.round(score * 0.15)}/15`,
                suggestions: submission.ai_feedback || 'Review feedback above for improvement tips.',
                detail: submission.ai_explanation || ''
            };
        }

        return {
            correctness: 'Not yet evaluated',
            efficiency: 'Not yet evaluated',
            code_style: 'Not yet evaluated',
            best_practices: 'Not yet evaluated',
            suggestions: ''
        };
    }

    function getEvaluationLine(submission, key, label, icon, color) {
        const evalData = parseEvaluation(submission);
        const value = evalData[key] || 'N/A';

        return `
            <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid var(--bg-tertiary);">
                <i class="fas ${icon}" style="color: ${color}; margin-top: 0.25rem; min-width: 16px;"></i>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 0.875rem; color: var(--text-primary);">${label}</div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem;">${value}</div>
                </div>
            </div>
        `;
    }

    function getSuggestionsSection(submission) {
        const evalData = parseEvaluation(submission);
        const suggestions = evalData.suggestions || '';

        if (!suggestions || suggestions === 'N/A') return '';

        return `
            <div style="background: var(--bg-card); padding: 1rem; border-radius: var(--radius-md);">
                <div style="font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-lightbulb" style="color: var(--warning-500);"></i> Suggestions
                </div>
                <p style="color: var(--text-secondary); line-height: 1.7; margin: 0;">${suggestions}</p>
            </div>
        `;
    }

    async function loadTaskSubmissions() {
        const container = document.getElementById('taskSubmissionsTable');

        try {
            const response = await fetch('/api/task-submissions');
            const submissions = await response.json();

            if (submissions.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-inbox"></i></div>
                    <h3>No task submissions yet</h3>
                    <p>Submit a task to see it here.</p>
                </div>
            `;
                return;
            }

            container.innerHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Submitted</th>
                        <th>Type</th>
                        <th>Score</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${submissions.map(sub => {
                const displayStatus = getStatusDisplay(sub.status, sub.score);
                return `
                        <tr>
                            <td><strong>${sub.task_title}</strong></td>
                            <td>${formatDate(sub.submitted_at)}</td>
                            <td><span class="type-badge coding">${sub.submission_type}</span></td>
                            <td><strong>${sub.score}/100</strong></td>
                            <td><span class="status-badge ${displayStatus}">${displayStatus.toUpperCase()}</span></td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewTaskReport(${JSON.stringify(sub).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-file-alt"></i> Report
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSubmission('task', ${sub.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `}).join('')}
                </tbody>
            </table>
        `;
        } catch (error) {
            container.innerHTML = '<p class="error">Failed to load submissions</p>';
        }
    }

    async function loadProblemSubmissions() {
        const container = document.getElementById('problemSubmissionsTable');

        try {
            const response = await fetch('/api/problem-submissions');
            const submissions = await response.json();

            if (submissions.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-inbox"></i></div>
                    <h3>No problem submissions yet</h3>
                    <p>Solve a problem to see it here.</p>
                </div>
            `;
                return;
            }

            container.innerHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Problem</th>
                        <th>Language</th>
                        <th>Submitted</th>
                        <th>Score</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${submissions.map(sub => {
                const displayStatus = getStatusDisplay(sub.status, sub.score);
                return `
                        <tr>
                            <td><strong>${sub.problem_title}</strong></td>
                            <td><span class="type-badge coding">${sub.language.toUpperCase()}</span></td>
                            <td>${formatDate(sub.submitted_at)}</td>
                            <td><strong>${sub.score}/100</strong></td>
                            <td>
                                <span class="status-badge ${displayStatus}">${displayStatus.toUpperCase()}</span>
                                ${sub.is_plagiarized ? `<span class="status-badge rejected" style="margin-left: 0.5rem;" title="Similarity: ${(sub.plagiarism_score * 100).toFixed(0)}%${sub.plagiarism_source_name ? ' from ' + sub.plagiarism_source_name : ''}"><i class="fas fa-exclamation-triangle"></i> PLAGIARIZED</span>` : ''}
                                ${(sub.focus_lost_count > 0 || sub.paste_attempts > 0) ? `<span class="status-badge warning" style="margin-left: 0.5rem;" title="Focus Lost: ${sub.focus_lost_count}, Paste: ${sub.paste_attempts}"><i class="fas fa-exclamation-circle"></i> VIOLATION</span>` : ''}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewProblemReport(${JSON.stringify(sub).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-file-alt"></i> Report
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSubmission('problem', ${sub.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `}).join('')}
                </tbody>
            </table>
        `;
        } catch (error) {
            container.innerHTML = '<p class="error">Failed to load submissions</p>';
        }
    }

    function viewTaskReport(submission) {
        const content = document.getElementById('reportContent');
        const displayStatus = getStatusDisplay(submission.status, submission.score);

        content.innerHTML = `
        <div style="display: grid; gap: 1.5rem;">
            <!-- Score Header -->
            <div class="submission-result ${displayStatus}" style="margin: 0;">
                <div class="result-header">
                    <div class="result-icon">
                        <i class="fas fa-${displayStatus === 'accepted' ? 'check' : 'times'}"></i>
                    </div>
                    <div>
                        <div class="result-title">${displayStatus === 'accepted' ? 'Accepted' : 'Rejected'}</div>
                        <div style="font-size: 0.875rem; opacity: 0.8;">${submission.task_title}</div>
                    </div>
                </div>
                <div class="result-score">${submission.score}/100</div>
            </div>
            
            <!-- Student Info -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-md); text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Type</div>
                    <span class="type-badge coding">${submission.submission_type}</span>
                </div>
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-md); text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Submitted</div>
                    <div style="font-weight: 500;">${formatDate(submission.submitted_at)}</div>
                </div>
            </div>
            
            <!-- Submission Content First -->
            ${submission.content ? `
            <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: 1.5rem;">
                <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-file-alt" style="color: var(--primary-500);"></i> Submission Content
                </h4>
                <pre style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); overflow-x: auto; font-size: 0.875rem; margin: 0; max-height: 250px; overflow-y: auto; white-space: pre-wrap;">${escapeHtml(submission.content)}</pre>
            </div>
            ` : ''}
            
            <!-- AI Evaluation Report -->
            <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: var(--radius-lg); padding: 1.5rem;">
                <h4 style="margin-bottom: 1rem; color: var(--primary-500); display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-robot"></i> AI Evaluation Report
                </h4>
                
                <div style="display: grid; gap: 1rem;">
                    <div style="background: var(--bg-card); padding: 1rem; border-radius: var(--radius-md);">
                        <div style="font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-comment" style="color: var(--primary-500);"></i> Feedback
                        </div>
                        <p style="color: var(--text-secondary); line-height: 1.7; margin: 0;">${submission.ai_feedback || 'No feedback available'}</p>
                    </div>
                    
                    <div style="background: var(--bg-card); padding: 1rem; border-radius: var(--radius-md);">
                        <div style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-chart-bar" style="color: var(--success-500);"></i> Detailed Analysis
                        </div>
                        <div style="display: grid; gap: 0.75rem;">
                            ${getEvaluationLine(submission, 'correctness', 'Correctness', 'fa-check-circle', 'var(--success-500)')}
                            ${getEvaluationLine(submission, 'efficiency', 'Efficiency', 'fa-bolt', 'var(--primary-500)')}
                            ${getEvaluationLine(submission, 'code_style', 'Code Style', 'fa-paint-brush', 'var(--warning-500)')}
                            ${getEvaluationLine(submission, 'best_practices', 'Best Practices', 'fa-star', 'var(--info-500)')}
                        </div>
                    </div>
                    
                    ${getSuggestionsSection(submission)}
                </div>
            </div>
        </div>
    `;

        openModal('reportModal');
    }

    function viewProblemReport(submission) {
        const content = document.getElementById('reportContent');
        const displayStatus = getStatusDisplay(submission.status, submission.score);

        content.innerHTML = `
        <div style="display: grid; gap: 1.5rem;">
            <!-- Score Header -->
            <div class="submission-result ${displayStatus}" style="margin: 0;">
                <div class="result-header">
                    <div class="result-icon">
                        <i class="fas fa-${displayStatus === 'accepted' ? 'check' : 'times'}"></i>
                    </div>
                    <div>
                        <div class="result-title">${displayStatus === 'accepted' ? 'Accepted' : 'Rejected'}</div>
                        <div style="font-size: 0.875rem; opacity: 0.8;">${submission.problem_title}</div>
                    </div>
                </div>
                <div class="result-score">${submission.score}/100</div>
            </div>
            
            ${submission.is_plagiarized ? `
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger-500); padding: 1rem; border-radius: var(--radius-md);">
                <div style="color: var(--danger-500); font-weight: 600; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-exclamation-triangle"></i> PLAGIARISM DETECTED
                </div>
                <div style="color: var(--text-primary);">
                    This submission has a <strong>${(submission.plagiarism_score * 100).toFixed(0)}% similarity</strong> match.
                    ${submission.plagiarism_source_name ? `<br>Copied from: <strong>${submission.plagiarism_source_name}</strong>` : ''}
                </div>
            </div>
            ` : ''}
            
            <!-- Student Info -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-md); text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Language</div>
                    <span class="type-badge coding">${submission.language.toUpperCase()}</span>
                </div>
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-md); text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Submitted</div>
                    <div style="font-weight: 500;">${formatDate(submission.submitted_at)}</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-md); text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Final Score</div>
                    <div style="font-weight: 700; font-size: 1.25rem; color: ${submission.score >= 60 ? 'var(--success-500)' : 'var(--danger-500)'};">${submission.score}%</div>
                </div>
            </div>
            
            <!-- Code First -->
            <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: 1.5rem;">
                <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-code" style="color: var(--primary-500);"></i> Your Code
                    <span class="type-badge coding" style="margin-left: auto;">${submission.language.toUpperCase()}</span>
                </h4>
                <pre style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); overflow-x: auto; font-size: 0.875rem; margin: 0; max-height: 250px; overflow-y: auto;">${escapeHtml(submission.code)}</pre>
            </div>
            
            <!-- AI Evaluation Report -->
            <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: var(--radius-lg); padding: 1.5rem;">
                <h4 style="margin-bottom: 1rem; color: var(--primary-500); display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-robot"></i> AI Evaluation Report
                </h4>
                
                <div style="display: grid; gap: 1rem;">
                    <div style="background: var(--bg-card); padding: 1rem; border-radius: var(--radius-md);">
                        <div style="font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-comment" style="color: var(--primary-500);"></i> Feedback
                        </div>
                        <p style="color: var(--text-secondary); line-height: 1.7; margin: 0;">${submission.ai_feedback || 'No feedback available'}</p>
                    </div>
                    
                    <div style="background: var(--bg-card); padding: 1rem; border-radius: var(--radius-md);">
                        <div style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-chart-bar" style="color: var(--success-500);"></i> Detailed Analysis
                        </div>
                        <div style="display: grid; gap: 0.75rem;">
                            ${getEvaluationLine(submission, 'correctness', 'Correctness', 'fa-check-circle', 'var(--success-500)')}
                            ${getEvaluationLine(submission, 'efficiency', 'Efficiency', 'fa-bolt', 'var(--primary-500)')}
                            ${getEvaluationLine(submission, 'code_style', 'Code Style', 'fa-paint-brush', 'var(--warning-500)')}
                            ${getEvaluationLine(submission, 'best_practices', 'Best Practices', 'fa-star', 'var(--info-500)')}
                        </div>
                    </div>
                    
                    ${getSuggestionsSection(submission)}
                </div>
            </div>
        </div>
    `;

        openModal('reportModal');
    }

    async function deleteSubmission(type, id) {
        if (!confirm('Are you sure you want to delete this submission?')) {
            return;
        }

        try {
            const response = await fetch(`/api/submissions/${type}/${id}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                showToast('success', 'Deleted', 'Submission deleted successfully');
                if (type === 'task') {
                    loadTaskSubmissions();
                } else {
                    loadProblemSubmissions();
                }
            } else {
                showToast('error', 'Error', result.message || 'Failed to delete');
            }
        } catch (error) {
            showToast('error', 'Error', 'Failed to delete submission');
        }
    }

    async function loadAptitudeSubmissions() {
        const container = document.getElementById('aptitudeSubmissionsTable');
        try {
            const response = await fetch('/api/aptitude-submissions');
            const submissions = await response.json();

            if (submissions.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-clipboard-check"></i></div>
                    <h3>No aptitude submissions</h3>
                    <p>Complete an aptitude test to see it here.</p>
                </div>
            `;
                return;
            }

            container.innerHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Test Title</th>
                        <th>Submitted</th>
                        <th>Questions</th>
                        <th>Score</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${submissions.map(sub => {
                const scorePerc = Math.round((sub.score / sub.total_questions) * 100);
                const statusClass = scorePerc >= 50 ? 'accepted' : (scorePerc >= 30 ? 'pending' : 'rejected');
                const statusText = scorePerc >= 50 ? 'Passed' : 'Failed';

                return `
                        <tr>
                            <td><strong>${sub.test_title}</strong></td>
                            <td>${formatDate(sub.submitted_at)}</td>
                            <td>${sub.total_questions}</td>
                            <td><strong>${sub.score}/${sub.total_questions} (${scorePerc}%)</strong></td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
            }).join('')}
                </tbody>
            </table>
            `;
        } catch (error) {
            container.innerHTML = '<p class="error">Failed to load aptitude submissions</p>';
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadTaskSubmissions();
        loadProblemSubmissions();
        loadAptitudeSubmissions();

        // Tab switching logic (override/ensure it works)
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector(`.tab-content[data-tab-content="${tab}"]`).classList.add('active');
            });
        });
    });

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
