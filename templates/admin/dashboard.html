{% extends "base.html" %}

{% block title %}Admin Dashboard - Mentor Hub{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-graduation-cap"></i>
                <span>Mentor Hub</span>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="{{ url_for('admin_dashboard') }}" class="nav-link active">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('admin_users') }}" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span>Users</span>
                </a>
                <a href="{{ url_for('admin_mentors') }}" class="nav-link">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Mentor Leaderboard</span>
                </a>
                <a href="{{ url_for('admin_students') }}" class="nav-link">
                    <i class="fas fa-user-graduate"></i>
                    <span>Student Leaderboard</span>
                </a>
                <div class="nav-section-title" style="margin-top: 1rem;">Content</div>
                <a href="{{ url_for('admin_tasks') }}" class="nav-link">
                    <i class="fas fa-tasks"></i>
                    <span>Tasks</span>
                </a>
                <a href="{{ url_for('admin_problems') }}" class="nav-link">
                    <i class="fas fa-code"></i>
                    <span>Assignments</span>
                </a>
                <a href="{{ url_for('admin_aptitude') }}" class="nav-link">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Aptitude Test</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" style="background: var(--gradient-danger);">{{ session['user_name'][0] }}</div>
                <div class="user-details">
                    <div class="user-name">{{ session['user_name'] }}</div>
                    <div class="user-role">Admin</div>
                </div>
            </div>
            <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-block btn-sm">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Admin Dashboard</h1>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <div class="content-body">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalMentors">-</div>
                        <div class="stat-label">Total Mentors</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalStudents">-</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalTasks">-</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalProblems">-</div>
                        <div class="stat-label">Total Problems</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalAptitude">-</div>
                        <div class="stat-label">Total Aptitude Tests</div>
                    </div>
                </div>
            </div>

            <div class="stats-grid" style="margin-top: 1.5rem;">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalTaskSubs">-</div>
                        <div class="stat-label">Task Submissions</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalProblemSubs">-</div>
                        <div class="stat-label">Problem Submissions</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalAptitudeSubs">-</div>
                        <div class="stat-label">Aptitude Submissions</div>
                    </div>
                </div>
            </div>

            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-top: 2.5rem;">
                <!-- Recent Activity Logs -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-history"></i> Recent Activity</h2>
                    </div>
                    <div class="card-body" id="activityLogs">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Recent Submissions -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-paper-plane"></i> Recent Submissions</h2>
                        <a href="{{ url_for('admin_students') }}" class="btn btn-sm btn-secondary">View All</a>
                    </div>
                    <div class="card-body" id="recentSubmissions">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Skill Distribution -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-chart-radar"></i> Global Skill Distribution</h2>
                    </div>
                    <div class="card-body"
                        style="height: 300px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="skillsChart"></canvas>
                    </div>
                </div>

                <!-- Mentor-Student Allocation -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-sitemap"></i> Mentor-Student Allocation</h2>
                        <a href="{{ url_for('admin_users') }}" class="btn btn-sm btn-secondary">Manage</a>
                    </div>
                    <div class="card-body table-container" id="allocationTable">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadStats();
        loadRecentSubmissions();
        loadSkillsChart();
        loadAllocation();
        loadActivityLogs();
    });

    async function loadStats() {
        try {
            const response = await fetch('/api/stats/dashboard');
            const stats = await response.json();

            document.getElementById('totalMentors').textContent = stats.total_mentors || 0;
            document.getElementById('totalStudents').textContent = stats.total_students || 0;
            document.getElementById('totalTasks').textContent = stats.total_tasks || 0;
            document.getElementById('totalProblems').textContent = stats.total_problems || 0;
            document.getElementById('totalAptitude').textContent = stats.total_aptitude_tests || 0;
            document.getElementById('totalTaskSubs').textContent = stats.total_task_submissions || 0;
            document.getElementById('totalProblemSubs').textContent = stats.total_problem_submissions || 0;
            document.getElementById('totalAptitudeSubs').textContent = stats.total_aptitude_submissions || 0;
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    async function loadRecentSubmissions() {
        const container = document.getElementById('recentSubmissions');

        try {
            const [taskRes, problemRes] = await Promise.all([
                fetch('/api/task-submissions'),
                fetch('/api/problem-submissions')
            ]);

            const taskSubmissions = await taskRes.json();
            const problemSubmissions = await problemRes.json();

            const allSubmissions = [
                ...taskSubmissions.map(s => ({ ...s, type: 'task' })),
                ...problemSubmissions.map(s => ({ ...s, type: 'problem' }))
            ].sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at)).slice(0, 10);

            if (allSubmissions.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-inbox"></i></div>
                    <h3>No submissions yet</h3>
                </div>
            `;
                return;
            }

            container.innerHTML = `
            <div class="leaderboard-list">
                ${allSubmissions.map(sub => `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank" style="background: ${sub.status === 'accepted' ? 'var(--gradient-success)' : 'var(--gradient-danger)'}; color: white; width: 32px; height: 32px; font-size: 0.875rem;">
                            <i class="fas fa-${sub.status === 'accepted' ? 'check' : 'times'}"></i>
                        </div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${sub.student_name} (${sub.mentor_name || 'Admin'})</div>
                            <div class="leaderboard-stats">
                                ${sub.task_title || sub.problem_title} 
                                • ${formatTimeAgo(sub.submitted_at)}
                            </div>
                        </div>
                        <div class="leaderboard-score">
                            <div class="score">${sub.score}</div>
                            <div class="label">Score</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        } catch (error) {
            container.innerHTML = '<p class="error">Failed to load submissions</p>';
        }
    }

    async function loadSkillsChart() {
        const ctx = document.getElementById('skillsChart').getContext('2d');
        try {
            const response = await fetch('/api/skills');
            const data = await response.json();

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Correctness', 'Efficiency', 'Code Style', 'Best Practices'],
                    datasets: [{
                        label: 'Platform Average',
                        data: [data.correctness, data.efficiency, data.code_style, data.best_practices],
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        borderColor: 'var(--danger-500)',
                        pointBackgroundColor: 'var(--danger-500)',
                        borderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            ticks: { display: false, stepSize: 20 },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                            pointLabels: {
                                color: '#94a3b8',
                                font: { size: 11, family: "'Inter', sans-serif" }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        } catch (e) {
            console.error("Chart error", e);
        }
    }

    async function loadAllocation() {
        const container = document.getElementById('allocationTable');

        try {
            const response = await fetch('/api/mentor-students');
            const students = await response.json();

            if (students.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-users"></i></div>
                    <h3>No students assigned</h3>
                </div>
            `;
                return;
            }

            // Group by mentor
            const grouped = students.reduce((acc, student) => {
                const mentor = student.mentor_name || 'Unassigned';
                if (!acc[mentor]) acc[mentor] = [];
                acc[mentor].push(student);
                return acc;
            }, {});

            container.innerHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Mentor</th>
                        <th>Student</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.entries(grouped).map(([mentor, students]) =>
                students.map((student, index) => `
                            <tr>
                                ${index === 0 ? `<td rowspan="${students.length}" style="vertical-align: top; font-weight: 600; background: var(--bg-secondary);">${mentor}</td>` : ''}
                                <td>${student.name}</td>
                            </tr>
                        `).join('')
            ).join('')}
                </tbody>
            </table>
        `;
        } catch (error) {
            container.innerHTML = '<p class="error">Failed to load allocation</p>';
        }
    }

    async function loadActivityLogs() {
        const container = document.getElementById('activityLogs');

        try {
            const response = await fetch('/api/activity-logs');
            const logs = await response.json();

            if (logs.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-history"></i></div>
                    <h3>No activity yet</h3>
                </div>
            `;
                return;
            }

            container.innerHTML = `
            <div class="leaderboard-list">
                ${logs.slice(0, 10).map(log => `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank" style="background: var(--gradient-${getActionColor(log.action)}); color: white;">
                            <i class="fas fa-${getActionIcon(log.action)}"></i>
                        </div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${log.user_name} (${log.user_role})</div>
                            <div class="leaderboard-stats">${log.details} • ${formatTimeAgo(log.created_at)}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        } catch (error) {
            container.innerHTML = '<p class="error">Failed to load activity</p>';
        }
    }

    function getActionIcon(action) {
        const icons = {
            'login': 'sign-in-alt',
            'logout': 'sign-out-alt',
            'create_task': 'plus',
            'create_problem': 'plus',
            'submit_task': 'paper-plane',
            'submit_problem': 'paper-plane',
            'delete_task': 'trash',
            'delete_problem': 'trash',
            'delete_submission': 'trash',
            'create_user': 'user-plus',
            'delete_user': 'user-minus'
        };
        return icons[action] || 'circle';
    }

    function getActionColor(action) {
        if (action.includes('delete')) return 'danger';
        if (action.includes('create') || action.includes('submit')) return 'success';
        if (action.includes('login')) return 'primary';
        return 'info';
    }
</script>
{% endblock %}
